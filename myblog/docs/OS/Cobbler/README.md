# Cobbler自动化系统安装环境配置

网络安装服务器套件 Cobbler(补鞋匠)是RedHat在2008年发布的，用于快速建立Linux网络安装环境。今天我们就用Cobbler来配置一套自动化系统安装环境。

## 0. 参考文档

- Cobbler官方文档：[https://cobbler.readthedocs.io/en/latest/](https://cobbler.readthedocs.io/en/latest/)
- Cobbler官网地址：[https://github.com/cobbler/cobbler](https://github.com/cobbler/cobbler)

## 1. 环境说明

- 宿主机：系统`Ubuntu 20.04.2 LTS`，IP:192.168.2.113。
- 虚拟化工具：VirtualBox 6.1.22。
- 虚拟机: 采用桥接网卡创建一个CentOS7虚拟机，命名为`cobbler-master`。

虚拟机创建注意事项：

- `VirtualBox`中设置虚拟机内存大小2048MB。
- `VirtualBox`中设置虚拟机虚拟分配空间40GB，此处空间稍微分配大一点，因为需要存放系统镜像，可能会占用较多空间。
- `VirtualBox`中设置虚拟机配置网卡1，启用网络连接，并设置连接方式为"桥接网卡"。

虚拟机其他信息：

操作系统：

```sh
[root@cobbler-master ~]# cat /etc/centos-release
CentOS Linux release 7.9.2009 (Core)
```

配置静态IP地址:

```sh
[root@cobbler-master ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp0s3 
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="none"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="enp0s3"
UUID="cde3dfd3-712f-40a3-9ab7-aa8d0fc31448"
DEVICE="enp0s3"
ONBOOT="yes"
IPADDR="192.168.2.20"
PREFIX="24"
GATEWAY="192.168.2.1"
IPV6_PRIVACY="no"
DNS1="192.168.2.1"
[root@localhost ~]# 
```

在安装虚拟机过程中，可以在网络配置时先选择DHCP方式自动连接网络，网络连接成功后，可以看到IP、网关、子网掩码、DNS等信息，将其记录下来，然后手动配置IP即可。

查看IP、网关、子网掩码、DNS等信息：

```sh
# IP信息,此处的192.168.2.20就是虚拟机的IP地址
[root@cobbler-master ~]# ip a show enp0s3
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:87:c2:4e brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.20/24 brd 192.168.2.255 scope global noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::d972:e36b:31ff:8dd1/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

# 网关信息，此处第2列的192.168.2.1就是网关IP地址
# 子网掩码信息，此处第3列的255.255.255.0则是子网掩码
[root@cobbler-master ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    100    0        0 enp0s3
192.168.2.0     0.0.0.0         255.255.255.0   U     100    0        0 enp0s3

# DNS域名服务器信息，此处的192.168.2.1则是域名服务器IP地址
[root@cobbler-master ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
nameserver 192.168.2.1
```

记录好这些信息，后面配置Cobbler DHCP时需要使用到。



另外，我们关闭VirtualBox主机网络管理器中的"DHCP服务器"，不启用服务器即可。



后续操作，除特殊说明外，都在在虚拟机`cobbler-master`中操作的。

## 2. YUM源配置

为了加快下载速度,我们将CentOS-Base源更新为国内的华为镜像。

```sh
[root@cobbler-master ~]# wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo
--2021-06-19 08:06:58--  https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo
Resolving repo.huaweicloud.com (repo.huaweicloud.com)... 58.49.156.108, 58.49.156.106, 58.49.156.107, ...
Connecting to repo.huaweicloud.com (repo.huaweicloud.com)|58.49.156.108|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1775 (1.7K) [application/octet-stream]
Saving to: ‘/etc/yum.repos.d/CentOS-Base.repo’

100%[=====================================>] 1,775       --.-K/s   in 0s      

2021-06-19 08:06:58 (96.4 MB/s) - ‘/etc/yum.repos.d/CentOS-Base.repo’ saved [1775/1775]

[root@cobbler-master ~]# 
```

配置清华大学的EPEL源镜像：

```sh
cat > /etc/yum.repos.d/epel.repo << EOF
[epel]
name=Extra Packages for Enterprise Linux 7 - \$basearch
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/\$basearch
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=\$basearch
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7

[epel-debuginfo]
name=Extra Packages for Enterprise Linux 7 - \$basearch - Debug
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/\$basearch/debug
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&arch=\$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1

[epel-source]
name=Extra Packages for Enterprise Linux 7 - \$basearch - Source
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/SRPMS
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&arch=\$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1
EOF
```

参考：[https://mirrors.tuna.tsinghua.edu.cn/help/epel/](https://mirrors.tuna.tsinghua.edu.cn/help/epel/)

## 3. 关闭Selinux

官方文档中关于Selinux的说明：

> Before getting started with Cobbler, it may be convenient to either disable SELinux or set it to “permissive” mode, especially if you are unfamiliar with SELinux troubleshooting or modifying SELinux policy. Cobbler constantly evolves to assist in managing new system technologies, and the policy that ships with your OS can sometimes lag behind the feature-set we provide, resulting in AVC denials that break Cobbler’s functionality.

大意是操作系统提供的特征策略有可能比Cobbler提供的功能集后滞后,因此建议关闭SELinux。

```sh
[root@cobbler-master ~]# getenforce 
Disabled
[root@cobbler-master ~]# cat /etc/selinux/config 

# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#     enforcing - SELinux security policy is enforced.
#     permissive - SELinux prints warnings instead of enforcing.
#     disabled - No SELinux policy is loaded.
SELINUX=disabled
# SELINUXTYPE= can take one of three values:
#     targeted - Targeted processes are protected,
#     minimum - Modification of targeted policy. Only selected processes are protected. 
#     mls - Multi Level Security protection.
SELINUXTYPE=targeted 
```

确保`getenforce`获取到在值是`Disabled`，如果不是的话，可以使用VIM打开配置文件`/etc/selinux/config`，将其第7行修改为`SELINUX=disabled`。修改完成后，使用命令`shutdown -r now`重启虚拟机。





参考：

- [EPEL镜像](https://mirrors.tuna.tsinghua.edu.cn/help/epel/)
- [CentOS镜像](https://repo.huaweicloud.com/centos/)

