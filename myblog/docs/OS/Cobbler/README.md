# Cobbler自动化系统安装环境配置

[[toc]]

网络安装服务器套件 Cobbler(补鞋匠)是RedHat在2008年发布的，用于快速建立Linux网络安装环境。今天我们就用Cobbler来配置一套自动化系统安装环境。

## 0. 参考文档

- Cobbler官方文档：[https://cobbler.readthedocs.io/en/latest/](https://cobbler.readthedocs.io/en/latest/)
- Cobbler官网地址：[https://github.com/cobbler/cobbler](https://github.com/cobbler/cobbler)

此处复制一段 [Cobbler自动化部署](https://www.cnblogs.com/yanjieli/p/11016825.html) 中的介绍。

> ## cobbler简介
>
> 1、`Cobbler`是一个`Linux`服务器安装的服务，可以通过网络启动（`PXE`）的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理`DHCP`，`DNS`等。
> 2、`Cobbler`可以使用命令行方式管理，也提供了基于Web的界面管理工具（`cobbler-web`），还提供了`API`接口，可以方便二次开发使用。
> 3、`Cobbler`是较早前的`kickstart`的升级版，优点是比较容易配置，还自带web界面比较易于管理。
> 4、`Cobbler`内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如`Puppet`。
>
> ## cobbler集成的服务
>
> - PXE服务支持
> - DHCP服务管理
> - DNS服务管理
> - 电源管理
> - Kickstart服务支持
> - YUM仓库管理
> - TFTP
> - Apache
>
> ## cobbler工作原理
> **Server端**
>
> - 启动`Cobbler`服务
> - 进行`Cobbler`错误检查，执行`cobbler check`命令
> - 进行配置同步，执行`cobbler sync`命令
> - 复制相关启动文件到`TFTP`目录中
> - 启动`DHCP`服务，提供地址分配
> - `DHCP`服务分配IP地址
> - `TFTP`传输启动文件
> - `Server`端接收安装信息
> - `Server`端发送`ISO`镜像与`Kickstart`文件
>
> **Client端**
>
> - 客户端以`PXE`模式启动
> - 客户端获取`IP`地址
> - 通过`TFTP`服务器获取启动文件
> - 进入`Cobbler`安装选择界面
> - 根据配置信息准备安装系统
> - 加载`Kickstart`文件
> - 传输系统安装的其它文件
> - 进行安装系统
>
> 作者：别来无恙-
>
> 出处：https://www.cnblogs.com/yanjieli/p/11016825.html
>
> 版权：本作品采用「[署名-非商业性使用-相同方式共享 4.0 国际](https://creativecommons.org/licenses/by-nc-sa/4.0/)」许可协议进行许可。



## 1. 环境说明

- 宿主机：系统`Ubuntu 20.04.2 LTS`，IP:192.168.2.113。
- 虚拟化工具：VirtualBox 6.1.22。
- 虚拟机: 采用桥接网卡创建一个CentOS7虚拟机，命名为`cobbler-master`。

虚拟机创建注意事项：

- `VirtualBox`中设置虚拟机内存大小2048MB。
- `VirtualBox`中设置虚拟机虚拟分配空间40GB，此处空间稍微分配大一点，因为需要存放系统镜像，可能会占用较多空间。
- `VirtualBox`中设置虚拟机配置网卡1，启用网络连接，并设置连接方式为"桥接网卡"。

虚拟机其他信息：

操作系统：

```sh
[root@cobbler-master ~]# cat /etc/centos-release
CentOS Linux release 7.9.2009 (Core)
```

配置静态IP地址:

```sh
[root@cobbler-master ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp0s3 
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="none"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="enp0s3"
UUID="cde3dfd3-712f-40a3-9ab7-aa8d0fc31448"
DEVICE="enp0s3"
ONBOOT="yes"
IPADDR="192.168.2.20"
PREFIX="24"
GATEWAY="192.168.2.1"
IPV6_PRIVACY="no"
DNS1="192.168.2.1"
[root@localhost ~]# 
```

在安装虚拟机过程中，可以在网络配置时先选择DHCP方式自动连接网络，网络连接成功后，可以看到IP、网关、子网掩码、DNS等信息，将其记录下来，然后手动配置IP即可。

查看IP、网关、子网掩码、DNS等信息：

```sh
# IP信息,此处的192.168.2.20就是虚拟机的IP地址
[root@cobbler-master ~]# ip a show enp0s3
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:87:c2:4e brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.20/24 brd 192.168.2.255 scope global noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::d972:e36b:31ff:8dd1/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

# 网关信息，此处第2列的192.168.2.1就是网关IP地址
# 子网掩码信息，此处第3列的255.255.255.0则是子网掩码
[root@cobbler-master ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    100    0        0 enp0s3
192.168.2.0     0.0.0.0         255.255.255.0   U     100    0        0 enp0s3

# DNS域名服务器信息，此处的192.168.2.1则是域名服务器IP地址
[root@cobbler-master ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
nameserver 192.168.2.1
```

记录好这些信息，后面配置Cobbler DHCP时需要使用到。



另外，我们关闭VirtualBox主机网络管理器中的"DHCP服务器"，不启用服务器即可。



后续操作，除特殊说明外，都在在虚拟机`cobbler-master`中操作的。

## 2. YUM源配置

为了加快下载速度,我们将CentOS-Base源更新为国内的华为镜像。

```sh
[root@cobbler-master ~]# wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo
--2021-06-19 08:06:58--  https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo
Resolving repo.huaweicloud.com (repo.huaweicloud.com)... 58.49.156.108, 58.49.156.106, 58.49.156.107, ...
Connecting to repo.huaweicloud.com (repo.huaweicloud.com)|58.49.156.108|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1775 (1.7K) [application/octet-stream]
Saving to: ‘/etc/yum.repos.d/CentOS-Base.repo’

100%[=====================================>] 1,775       --.-K/s   in 0s      

2021-06-19 08:06:58 (96.4 MB/s) - ‘/etc/yum.repos.d/CentOS-Base.repo’ saved [1775/1775]

[root@cobbler-master ~]# 
```

配置清华大学的EPEL源镜像：

```sh
cat > /etc/yum.repos.d/epel.repo << EOF
[epel]
name=Extra Packages for Enterprise Linux 7 - \$basearch
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/\$basearch
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=\$basearch
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7

[epel-debuginfo]
name=Extra Packages for Enterprise Linux 7 - \$basearch - Debug
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/\$basearch/debug
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&arch=\$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1

[epel-source]
name=Extra Packages for Enterprise Linux 7 - \$basearch - Source
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/SRPMS
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&arch=\$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1
EOF
```

参考：[https://mirrors.tuna.tsinghua.edu.cn/help/epel/](https://mirrors.tuna.tsinghua.edu.cn/help/epel/)

## 3. 关闭Selinux

官方文档中关于Selinux的说明：

> Before getting started with Cobbler, it may be convenient to either disable SELinux or set it to “permissive” mode, especially if you are unfamiliar with SELinux troubleshooting or modifying SELinux policy. Cobbler constantly evolves to assist in managing new system technologies, and the policy that ships with your OS can sometimes lag behind the feature-set we provide, resulting in AVC denials that break Cobbler’s functionality.

大意是操作系统提供的特征策略有可能比Cobbler提供的功能集后滞后,因此建议关闭SELinux。

```sh
[root@cobbler-master ~]# getenforce 
Disabled
[root@cobbler-master ~]# cat /etc/selinux/config 

# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#     enforcing - SELinux security policy is enforced.
#     permissive - SELinux prints warnings instead of enforcing.
#     disabled - No SELinux policy is loaded.
SELINUX=disabled
# SELINUXTYPE= can take one of three values:
#     targeted - Targeted processes are protected,
#     minimum - Modification of targeted policy. Only selected processes are protected. 
#     mls - Multi Level Security protection.
SELINUXTYPE=targeted 
```

确保`getenforce`获取到在值是`Disabled`，如果不是的话，可以使用VIM打开配置文件`/etc/selinux/config`，将其第7行修改为`SELINUX=disabled`。修改完成后，使用命令`shutdown -r now`重启虚拟机。

## 4. cobbler安装

参考：[https://cobbler.readthedocs.io/en/latest/installation-guide.html](https://cobbler.readthedocs.io/en/latest/installation-guide.html)

```
httpd： 通过web服务检测管理cobbler
rsync： 远程同步管理、同步dhcp
xinetd：管理rsync、tftp-server服务
tftp-server：tftp简单文件传输包，传输启动文件
dhcp: DHCP服务分配IP地址
pykickstart：无人值守安装模板，即应答文件
cobbler：cobbler主包,cobbler的核心
cobbler-web：cobbler支持web服务包（图形化界面）
```

安装：

```sh
[root@cobbler-master ~]# yum install httpd xinetd tftp-server dhcp  pykickstart cobbler cobbler-web -y
... 省略
Installed:
  cobbler.x86_64 0:2.8.5-0.3.el7        cobbler-web.noarch 0:2.8.5-0.3.el7    
  dhcp.x86_64 12:4.2.5-83.el7.centos.1  pykickstart.noarch 0:1.99.66.22-1.el7 
  tftp-server.x86_64 0:5.2-22.el7       xinetd.x86_64 2:2.3.15-14.el7         

Dependency Installed:
  PyYAML.x86_64 0:3.10-11.el7                                                  
  createrepo.noarch 0:0.9.9-28.el7                                             
  deltarpm.x86_64 0:3.6-3.el7                                                  
  genisoimage.x86_64 0:1.1.11-25.el7                                           
  jbigkit-libs.x86_64 0:2.0-11.el7                                             
  libjpeg-turbo.x86_64 0:1.2.90-8.el7                                          
  libtiff.x86_64 0:4.0.3-35.el7                                                
  libusal.x86_64 0:1.1.11-25.el7                                               
  libwebp.x86_64 0:0.3.0-10.el7_9                                              
  libxml2-python.x86_64 0:2.9.1-6.el7.5                                        
  libyaml.x86_64 0:0.1.4-11.el7_0                                              
  mod_ssl.x86_64 1:2.4.6-97.el7.centos                                         
  mod_wsgi.x86_64 0:3.4-18.el7                                                 
  mtools.x86_64 0:4.0.18-5.el7                                                 
  python-backports.x86_64 0:1.0-8.el7                                          
  python-backports-ssl_match_hostname.noarch 0:3.5.0.1-1.el7                   
  python-chardet.noarch 0:2.2.1-3.el7                                          
  python-cheetah.x86_64 0:2.4.4-5.el7.centos                                   
  python-deltarpm.x86_64 0:3.6-3.el7                                           
  python-django-bash-completion.noarch 0:1.11.27-1.el7                         
  python-ipaddress.noarch 0:1.0.16-2.el7                                       
  python-kitchen.noarch 0:1.1.1-5.el7                                          
  python-netaddr.noarch 0:0.7.5-9.el7                                          
  python-pillow.x86_64 0:2.0.0-21.gitd1c6db8.el7                               
  python-pygments.noarch 0:1.4-10.el7                                          
  python-setuptools.noarch 0:0.9.8-7.el7                                       
  python2-django.noarch 0:1.11.27-1.el7                                        
  python2-markdown.noarch 0:2.4.1-4.el7                                        
  python2-pyyaml.noarch 0:3.10-0.el7                                           
  python2-simplejson.x86_64 0:3.10.0-2.el7                                     
  pytz.noarch 0:2016.10-2.el7                                                  
  rsync.x86_64 0:3.1.2-10.el7                                                  
  syslinux.x86_64 0:4.05-15.el7                                                
  yum-utils.noarch 0:1.1.31-54.el7_8                                           

Dependency Updated:
  dhclient.x86_64 12:4.2.5-83.el7.centos.1                                     
  dhcp-common.x86_64 12:4.2.5-83.el7.centos.1                                  
  dhcp-libs.x86_64 12:4.2.5-83.el7.centos.1                                    

Complete!
[root@cobbler-master ~]# 
```

## 5. 启动cobblerd服务

我们先启动httpd服务，再启动cobblerd服务。

```sh
# 启动服务
[root@cobbler-master ~]# systemctl start httpd cobblerd

# 添加开机启动
[root@cobbler-master ~]# systemctl enable httpd cobblerd
Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.
Created symlink from /etc/systemd/system/multi-user.target.wants/cobblerd.service to /usr/lib/systemd/system/cobblerd.service.

查看httpd和cobblerd服务状态
[root@cobbler-master ~]# systemctl status httpd cobblerd
● httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled)
   Active: active (running) since 六 2021-06-19 09:07:17 CST; 36s ago
     Docs: man:httpd(8)
           man:apachectl(8)
 Main PID: 1683 (httpd)
   Status: "Total requests: 0; Current requests/sec: 0; Current traffic:   0 B/sec"
   CGroup: /system.slice/httpd.service
           ├─1683 /usr/sbin/httpd -DFOREGROUND
           ├─1687 (wsgi:cobbler_w -DFOREGROUND
           ├─1688 /usr/sbin/httpd -DFOREGROUND
           ├─1689 /usr/sbin/httpd -DFOREGROUND
           ├─1690 /usr/sbin/httpd -DFOREGROUND
           ├─1691 /usr/sbin/httpd -DFOREGROUND
           └─1692 /usr/sbin/httpd -DFOREGROUND

6月 19 09:07:17 cobbler-master systemd[1]: Starting The Apache HTTP Server...
6月 19 09:07:17 cobbler-master httpd[1683]: AH00558: httpd: Could not reli...e
6月 19 09:07:17 cobbler-master systemd[1]: Started The Apache HTTP Server.

● cobblerd.service - Cobbler Helper Daemon
   Loaded: loaded (/usr/lib/systemd/system/cobblerd.service; enabled; vendor preset: disabled)
   Active: active (running) since 六 2021-06-19 09:07:17 CST; 36s ago
 Main PID: 1684 (cobblerd)
   CGroup: /system.slice/cobblerd.service
           └─1684 /usr/bin/python2 -s /usr/bin/cobblerd -F

6月 19 09:07:17 cobbler-master systemd[1]: Starting Cobbler Helper Daemon...
6月 19 09:07:17 cobbler-master systemd[1]: Started Cobbler Helper Daemon.
Hint: Some lines were ellipsized, use -l to show in full.
[root@cobbler-master ~]# 
```

### 5.1 查看cobbler版本信息

```sh
[root@cobbler-master ~]# cobbler version
Cobbler 2.8.5
  source: ?, ?
  build time: Tue Oct 15 01:59:43 2019
[root@cobbler-master ~]# 
```

### 5.2 查看cobbler帮助信息

```sh
[root@cobbler-master ~]# cobbler --help
usage
=====
cobbler <distro|profile|system|repo|image|mgmtclass|package|file> ... 
        [add|edit|copy|getks*|list|remove|rename|report] [options|--help]
cobbler <aclsetup|buildiso|import|list|replicate|report|reposync|sync|validateks|version|signature|get-loaders|hardlink> [options|--help]
[root@cobbler-master ~]# 
```







参考：

- [EPEL镜像](https://mirrors.tuna.tsinghua.edu.cn/help/epel/)
- [CentOS镜像](https://repo.huaweicloud.com/centos/)
- [Cobbler自动化部署](https://www.cnblogs.com/yanjieli/p/11016825.html)

